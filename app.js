// Language support
const translations = {
  bn: {
    // App
    "app_title": "‡¶î‡¶∑‡¶ß ‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®",
    "menu": "‡¶Æ‡ßá‡¶®‡ßÅ",
    "close": "‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®",
    "language": "‡¶≠‡¶æ‡¶∑‡¶æ",
    "bengali": "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ",
    "bengali_english": "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶á‡¶Ç‡¶≤‡¶ø‡¶∂",
    
    // Install
    "install_title": "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®",
    "install_message": "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® üíä",
    "skip": "‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡¶®",
    "install": "‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®",
    
    // Medicine Form
    "add_medicine": "‡¶®‡¶§‡ßÅ‡¶® ‡¶î‡¶∑‡¶ß ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®",
    "medicine_name": "‡¶î‡¶∑‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ",
    "medicine_name_placeholder": "‡¶î‡¶∑‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®",
    "intake_time": "‡¶ñ‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º",
    "start_date": "‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ",
    "days_count": "‡¶¶‡¶ø‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ",
    "days_placeholder": "‡¶ï‡¶§ ‡¶¶‡¶ø‡¶® ‡¶ñ‡¶æ‡¶¨‡ßá‡¶®",
    "next_dose_timer": "‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶°‡ßã‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®",
    "hours": "‡¶ò‡¶®‡ßç‡¶ü‡¶æ",
    "minutes": "‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü",
    "seconds": "‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°",
    "default_timer": "‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü: 10 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° (‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)",
    "end_date": "‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ",
    "add_medicine_button": "‡¶î‡¶∑‡¶ß ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®",
    
    // Time options
    "morning": "‡¶∏‡¶ï‡¶æ‡¶≤",
    "noon": "‡¶¶‡ßÅ‡¶™‡ßÅ‡¶∞",
    "night": "‡¶∞‡¶æ‡¶§",
    "morning_night": "‡¶∏‡¶ï‡¶æ‡¶≤ ‡¶ì ‡¶∞‡¶æ‡¶§",
    "morning_noon_night": "‡¶∏‡¶ï‡¶æ‡¶≤, ‡¶¶‡ßÅ‡¶™‡ßÅ‡¶∞ ‡¶ì ‡¶∞‡¶æ‡¶§",
    "other": "‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø",
    
    // Menu items
    "export_data": "‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü",
    "import_data": "‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü",
    "clear_all": "‡¶∏‡¶¨ ‡¶°‡ßá‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü",
    "help_line": "‡¶π‡ßá‡¶≤‡ßç‡¶™ ‡¶≤‡¶æ‡¶á‡¶®",
    "share_app": "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®",
    "how_to_use": "‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®",
    
    // Search
    "search_placeholder": "üîç ‡¶î‡¶∑‡¶ß ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...",
    
    // Medicine card
    "taken": "‡¶ñ‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡¶ø",
    "take": "‡¶ñ‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡¶ø?",
    
    // How to use
    "complete_guide": "‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ó‡¶æ‡¶á‡¶°‡¶≤‡¶æ‡¶á‡¶®",
    "add_medicine_guide": "‡¶®‡¶§‡ßÅ‡¶® ‡¶î‡¶∑‡¶ß ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ",
    "mark_taken": "‡¶î‡¶∑‡¶ß ‡¶ñ‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡¶ø ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ",
    "timer_system": "‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ",
    "search_medicine": "‡¶î‡¶∑‡¶ß ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ",
    "data_backup": "‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™",
    "data_restore": "‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞",
    "app_share": "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞",
    "app_install": "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤",
    
    // Guide steps
    "guide_step1": "‡¶î‡¶∑‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶®‡¶æ‡¶™‡¶æ, ‡¶è‡¶®‡ßç‡¶ü‡¶ø‡¶¨‡¶æ‡¶Ø‡¶º‡ßã‡¶ü‡¶ø‡¶ï)",
    "guide_step2": "‡¶ñ‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶∏‡¶ï‡¶æ‡¶≤, ‡¶¶‡ßÅ‡¶™‡ßÅ‡¶∞, ‡¶∞‡¶æ‡¶§)",
    "guide_step3": "‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®",
    "guide_step4": "‡¶ï‡¶§‡¶¶‡¶ø‡¶® ‡¶ñ‡¶æ‡¶¨‡ßá‡¶® ‡¶§‡¶æ ‡¶¶‡¶ø‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®",
    "guide_step5": "‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá \"‡¶î‡¶∑‡¶ß ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®\" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®",
    
    // Guide descriptions
    "mark_taken_desc": "‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶î‡¶∑‡¶ß‡ßá‡¶∞ ‡¶™‡¶æ‡¶∂‡ßá \"‡¶ñ‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡¶ø?\" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶∏‡¶¨‡ßÅ‡¶ú ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç \"‚úÖ ‡¶ñ‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡¶ø\" ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡•§",
    "timer_system_desc": "‡¶î‡¶∑‡¶ß ‡¶ñ‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡¶ø ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶°‡ßã‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá‡•§ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶î‡¶∑‡¶ß‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶æ‡¶≤ ‡¶∞‡¶ô‡ßá ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶¨‡ßá‡•§",
    "search_medicine_desc": "‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶î‡¶∑‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá Real-time ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§",
    "data_backup_desc": "‡¶Æ‡ßá‡¶®‡ßÅ ‡¶•‡ßá‡¶ï‡ßá \"‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü\" ‡¶è ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶¨ ‡¶°‡ßá‡¶ü‡¶æ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§",
    "data_restore_desc": "‡¶Æ‡ßá‡¶®‡ßÅ ‡¶•‡ßá‡¶ï‡ßá \"‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü\" ‡¶è ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",
    "app_share_desc": "‡¶Æ‡ßá‡¶®‡ßÅ ‡¶•‡ßá‡¶ï‡ßá \"‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®\" ‡¶è ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá QR ‡¶ï‡ßã‡¶° ‡¶¶‡ßá‡¶ñ‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",
    "app_install_desc": "‡¶â‡¶™‡¶∞‡ßá‡¶∞ \"‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤\" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßã‡¶®‡ßá ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®„ÄÇ",
    
    // QR Code
    "qr_code": "QR ‡¶ï‡ßã‡¶°",
    "qr_instruction": "‡¶è‡¶á QR ‡¶ï‡ßã‡¶° ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®",
    
    // Empty state
    "no_medicine": "‡¶ï‡ßã‡¶® ‡¶î‡¶∑‡¶ß ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø",
    "add_first_medicine": "‡¶Æ‡ßá‡¶®‡ßÅ ‡¶•‡ßá‡¶ï‡ßá \"‡¶®‡¶§‡ßÅ‡¶® ‡¶î‡¶∑‡¶ß ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®\" ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®"
  },
  en: {
    // App
    "app_title": "Medicine Reminder",
    "menu": "Menu",
    "close": "Close",
    "language": "Language",
    "bengali": "Bengali",
    "bengali_english": "Bengali English",
    
    // Install
    "install_title": "Install App",
    "install_message": "You can install this app if you want üíä",
    "skip": "Skip",
    "install": "Install",
    
    // Medicine Form
    "add_medicine": "Add New Medicine",
    "medicine_name": "Medicine Name",
    "medicine_name_placeholder": "Enter medicine name",
    "intake_time": "Intake Time",
    "start_date": "Start Date",
    "days_count": "Days Count",
    "days_placeholder": "How many days",
    "next_dose_timer": "Set Next Dose Timer",
    "hours": "Hours",
    "minutes": "Minutes",
    "seconds": "Seconds",
    "default_timer": "Default: 10 seconds (for testing)",
    "end_date": "End Date",
    "add_medicine_button": "Add Medicine",
    
    // Time options
    "morning": "Morning",
    "noon": "Noon",
    "night": "Night",
    "morning_night": "Morning & Night",
    "morning_noon_night": "Morning, Noon & Night",
    "other": "Other",
    
    // Menu items
    "export_data": "Export Data",
    "import_data": "Import Data",
    "clear_all": "Clear All Data",
    "help_line": "Help Line",
    "share_app": "Share App",
    "how_to_use": "How to Use",
    
    // Search
    "search_placeholder": "üîç Search medicine...",
    
    // Medicine card
    "taken": "Taken",
    "take": "Taken?",
    
    // How to use
    "complete_guide": "Complete Guide",
    "add_medicine_guide": "Adding New Medicine",
    "mark_taken": "Marking Medicine as Taken",
    "timer_system": "Timer System",
    "search_medicine": "Finding Medicine",
    "data_backup": "Data Backup",
    "data_restore": "Data Restore",
    "app_share": "App Sharing",
    "app_install": "App Installation",
    
    // Guide steps
    "guide_step1": "Enter medicine name (e.g., Napa, Antibiotic)",
    "guide_step2": "Select intake time (Morning, Noon, Night)",
    "guide_step3": "Select start date",
    "guide_step4": "Enter how many days to take",
    "guide_step5": "Click \"Add Medicine\" button with all information",
    
    // Guide descriptions
    "mark_taken_desc": "Click the \"Taken?\" button next to each medicine to mark it. It will turn green and show \"‚úÖ Taken\".",
    "timer_system_desc": "After marking medicine as taken, the timer for the next dose will start. When the timer ends, the medicine card will flash in red.",
    "search_medicine_desc": "Type the medicine name in the search box to find it in real-time.",
    "data_backup_desc": "Click \"Export Data\" from the menu to download all your data.",
    "data_restore_desc": "Click \"Import Data\" from the menu to upload previous data.",
    "app_share_desc": "Click \"Share App\" from the menu to see QR code and share the app.",
    "app_install_desc": "Click the \"Install\" button to install the app on your phone.",
    
    // QR Code
    "qr_code": "QR Code",
    "qr_instruction": "Scan this QR code to share the app",
    
    // Empty state
    "no_medicine": "No medicine added",
    "add_first_medicine": "Click \"Add New Medicine\" from menu"
  }
};

// Current language
let currentLang = 'bn';

// App initialization
document.addEventListener('DOMContentLoaded', function() {
  // Load language preference
  const savedLang = localStorage.getItem('medicineReminderLang');
  if (savedLang) {
    currentLang = savedLang;
  }
  
  // Apply language
  applyLanguage(currentLang);
  
  // Check if install prompt was shown before
  const installShown = localStorage.getItem('installPromptShown');
  if (!installShown) {
    // Show install popup first time only
    document.getElementById('installPopup').classList.remove('hidden');
    localStorage.setItem('installPromptShown', 'true');
  } else {
    // Skip install popup and show main app
    showMainApp();
  }
  
  // Set default date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('startDate').value = today;
  
  // Set default timer values for testing
  document.getElementById('timerSeconds').value = 10;
  
  // Event listeners for UI elements
  setupEventListeners();
  
  // Calculate end date when days or start date changes
  document.getElementById('medicineDays').addEventListener('input', calculateEndDate);
  document.getElementById('startDate').addEventListener('change', calculateEndDate);
  
  // Language switcher
  document.getElementById('langBn').addEventListener('click', () => switchLanguage('bn'));
  document.getElementById('langEn').addEventListener('click', () => switchLanguage('en'));
  
  // Install prompt buttons
  document.getElementById('installCancelBtn').addEventListener('click', function() {
    document.getElementById('installPopup').classList.add('hidden');
    showMainApp();
  });
  
  document.getElementById('installConfirmBtn').addEventListener('click', function() {
    document.getElementById('installPopup').classList.add('hidden');
    showMainApp();
    showToast(getTranslation('install_success'), 'success');
    
    // Trigger PWA install
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        } else {
          console.log('User dismissed the install prompt');
        }
        deferredPrompt = null;
      });
    }
  });
});

// Language functions
function switchLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('medicineReminderLang', lang);
  applyLanguage(lang);
  
  // Update language buttons
  document.getElementById('langBn').classList.toggle('bg-green-500', lang === 'bn');
  document.getElementById('langBn').classList.toggle('text-white', lang === 'bn');
  document.getElementById('langEn').classList.toggle('bg-green-500', lang === 'en');
  document.getElementById('langEn').classList.toggle('text-white', lang === 'en');
  
  // Reload medicines to update language
  loadMedicines();
}

function applyLanguage(lang) {
  // Update all elements with data-i18n attribute
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    if (translations[lang][key]) {
      element.textContent = translations[lang][key];
    }
  });
  
  // Update placeholder texts
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    if (translations[lang][key]) {
      element.setAttribute('placeholder', translations[lang][key]);
    }
  });
  
  // Update language buttons
  document.getElementById('langBn').classList.toggle('bg-green-500', lang === 'bn');
  document.getElementById('langBn').classList.toggle('text-white', lang === 'bn');
  document.getElementById('langEn').classList.toggle('bg-green-500', lang === 'en');
  document.getElementById('langEn').classList.toggle('text-white', lang === 'en');
}

function getTranslation(key) {
  return translations[currentLang][key] || key;
}

// Show main app after install prompt
function showMainApp() {
  // Hide splash screen and show main app after delay
  setTimeout(() => {
    document.getElementById('splashScreen').style.display = 'none';
    document.getElementById('mainApp').classList.remove('hidden');
    loadMedicines();
    startTimers();
  }, 1000);
}

// Toggle medicine form visibility
function toggleMedicineForm() {
  const form = document.getElementById('medicineForm');
  form.classList.toggle('hidden');
  toggleMenu();
  
  if (!form.classList.contains('hidden')) {
    form.scrollIntoView({ behavior: 'smooth' });
  }
}

// Setup all event listeners
function setupEventListeners() {
  // Menu toggle
  document.getElementById('menuButton').addEventListener('click', toggleMenu);
  document.getElementById('closeMenu').addEventListener('click', toggleMenu);
  document.getElementById('menuBackdrop').addEventListener('click', toggleMenu);
  
  // Add medicine button
  document.getElementById('addMedicine').addEventListener('click', addMedicine);
  
  // Search functionality
  document.getElementById('searchInput').addEventListener('input', searchMedicines);
  
  // Modal close buttons
  document.getElementById('closeQR').addEventListener('click', () => toggleModal('qrModal'));
  document.getElementById('closeHowToUse').addEventListener('click', () => toggleModal('howToUseModal'));
  
  // Menu item buttons
  document.getElementById('exportData').addEventListener('click', exportData);
  document.getElementById('importData').addEventListener('click', importData);
  document.getElementById('clearAll').addEventListener('click', clearAllData);
  document.getElementById('helpLine').addEventListener('click', showHelpLine);
  document.getElementById('shareApp').addEventListener('click', shareApp);
  document.getElementById('howToUse').addEventListener('click', () => toggleModal('howToUseModal'));
}

// Toggle menu visibility
function toggleMenu() {
  const menu = document.getElementById('threeDotMenu');
  const isHidden = menu.classList.contains('hidden');
  
  if (isHidden) {
    menu.classList.remove('hidden');
    setTimeout(() => {
      document.getElementById('menuPanel').classList.remove('-translate-x-full');
    }, 10);
  } else {
    document.getElementById('menuPanel').classList.add('-translate-x-full');
    setTimeout(() => {
      menu.classList.add('hidden');
    }, 300);
  }
}

// Toggle modal visibility
function toggleModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.toggle('hidden');
  
  if (modalId === 'qrModal' && !modal.classList.contains('hidden')) {
    generateQRCode();
  }
}

// Calculate end date based on start date and days
function calculateEndDate() {
  const startDate = document.getElementById('startDate').value;
  const days = parseInt(document.getElementById('medicineDays').value);
  
  if (startDate && days) {
    const start = new Date(startDate);
    const end = new Date(start);
    end.setDate(start.getDate() + days - 1);
    
    const formattedEndDate = end.toLocaleDateString(currentLang === 'bn' ? 'bn-BD' : 'en-US');
    document.getElementById('calculatedEndDate').textContent = formattedEndDate;
    document.getElementById('endDateDisplay').classList.remove('hidden');
  } else {
    document.getElementById('endDateDisplay').classList.add('hidden');
  }
}

// Add new medicine
function addMedicine() {
  const name = document.getElementById('medicineName').value.trim();
  const time = document.getElementById('medicineTime').value;
  const startDate = document.getElementById('startDate').value;
  const days = parseInt(document.getElementById('medicineDays').value);
  
  // Timer values
  const hours = parseInt(document.getElementById('timerHours').value) || 0;
  const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
  const seconds = parseInt(document.getElementById('timerSeconds').value) || 10;
  
  const totalSeconds = hours * 3600 + minutes * 60 + seconds;
  
  if (!name || !startDate || !days) {
    showToast(getTranslation('fill_all_fields'), 'error');
    return;
  }
  
  // Calculate end date
  const start = new Date(startDate);
  const end = new Date(start);
  end.setDate(start.getDate() + days - 1);
  
  const medicine = {
    id: Date.now(),
    name: name,
    time: time,
    startDate: startDate,
    endDate: end.toISOString().split('T')[0],
    days: days,
    timerDuration: totalSeconds,
    timerRemaining: totalSeconds,
    taken: false,
    missedDays: 0,
    createdAt: new Date().toISOString()
  };
  
  // Save to localStorage
  const medicines = getMedicines();
  medicines.push(medicine);
  localStorage.setItem('medicines', JSON.stringify(medicines));
  
  // Reset form and hide it
  document.getElementById('medicineName').value = '';
  document.getElementById('medicineDays').value = '';
  document.getElementById('endDateDisplay').classList.add('hidden');
  document.getElementById('medicineForm').classList.add('hidden');
  
  // Reload medicines
  loadMedicines();
  
  showToast(getTranslation('medicine_added'), 'success');
}

// Load medicines from localStorage
function loadMedicines() {
  const medicines = getMedicines();
  const medicineList = document.getElementById('medicineList');
  
  if (medicines.length === 0) {
    medicineList.innerHTML = `
      <div class="neumorphic rounded-2xl p-6 text-center">
        <i class="fas fa-pills text-gray-400 text-4xl mb-4"></i>
        <p class="text-gray-600">${getTranslation('no_medicine')}</p>
        <p class="text-gray-500 text-sm mt-2">${getTranslation('add_first_medicine')}</p>
      </div>
    `;
    return;
  }
  
  medicineList.innerHTML = '';
  
  medicines.forEach(medicine => {
    const medicineCard = document.createElement('div');
    medicineCard.className = 'neumorphic rounded-2xl p-5 fade-in';
    medicineCard.dataset.id = medicine.id;
    
    // Calculate progress
    const start = new Date(medicine.startDate);
    const end = new Date(medicine.endDate);
    const today = new Date();
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    const daysPassed = Math.ceil((today - start) / (1000 * 60 * 60 * 24)) + 1;
    const progress = Math.min(Math.max(daysPassed / totalDays, 0), 1) * 100;
    
    // Format dates for display
    const startDateFormatted = new Date(medicine.startDate).toLocaleDateString(currentLang === 'bn' ? 'bn-BD' : 'en-US');
    const endDateFormatted = new Date(medicine.endDate).toLocaleDateString(currentLang === 'bn' ? 'bn-BD' : 'en-US');
    
    // Timer display
    const timerDisplay = formatTime(medicine.timerRemaining);
    
    // Card content
    medicineCard.innerHTML = `
      <div class="flex justify-between items-start mb-3">
        <h3 class="text-lg font-semibold text-gray-800">${medicine.name}</h3>
        <div class="flex space-x-2">
          ${medicine.missedDays > 0 ? `<span class="missed-days">${medicine.missedDays} ${currentLang === 'bn' ? '‡¶¶‡¶ø‡¶® ‡¶Æ‡¶ø‡¶∏' : 'days missed'}</span>` : ''}
          <button class="delete-btn neumorphic-btn w-8 h-8 flex items-center justify-center rounded-full text-red-500">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="flex items-center">
          <i class="fas fa-clock text-blue-500 mr-2"></i>
          <span class="text-gray-700">${medicine.time}</span>
        </div>
        <div class="flex items-center">
          <i class="fas fa-calendar text-green-500 mr-2"></i>
          <span class="text-gray-700">${medicine.days} ${currentLang === 'bn' ? '‡¶¶‡¶ø‡¶®' : 'days'}</span>
        </div>
        <div class="flex items-center">
          <i class="fas fa-play-circle text-purple-500 mr-2"></i>
          <span class="text-gray-700">${startDateFormatted}</span>
        </div>
        <div class="flex items-center">
          <i class="fas fa-flag-checkered text-red-500 mr-2"></i>
          <span class="text-gray-700">${endDateFormatted}</span>
        </div>
      </div>
      
      <!-- Progress Bar -->
      <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-600 mb-1">
          <span>${currentLang === 'bn' ? '‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø' : 'Progress'}</span>
          <span>${Math.round(progress)}%</span>
        </div>
        <div class="neumorphic-inset h-2 rounded-full overflow-hidden">
          <div class="h-full bg-gradient-to-r from-green-400 to-blue-500 rounded-full" style="width: ${progress}%"></div>
        </div>
      </div>
      
      <!-- Timer and Action Button -->
      <div class="flex justify-between items-center">
        <div class="timer ${medicine.timerRemaining <= 60 ? 'flash' : ''}">${timerDisplay}</div>
        <button class="take-btn ${medicine.taken ? 'bg-green-500 text-white' : 'neumorphic-btn text-gray-700'} px-4 py-2 rounded-xl transition-all duration-200">
          ${medicine.taken ? '‚úÖ ' + getTranslation('taken') : getTranslation('take')}
        </button>
      </div>
    `;
    
    medicineList.appendChild(medicineCard);
    
    // Add event listeners for buttons
    medicineCard.querySelector('.take-btn').addEventListener('click', () => markAsTaken(medicine.id));
    medicineCard.querySelector('.delete-btn').addEventListener('click', () => deleteMedicine(medicine.id));
  });
}

// Get medicines from localStorage
function getMedicines() {
  return JSON.parse(localStorage.getItem('medicines') || '[]');
}

// Save medicines to localStorage
function saveMedicines(medicines) {
  localStorage.setItem('medicines', JSON.stringify(medicines));
}

// Ma